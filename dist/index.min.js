// @bun
var S=new TextEncoder,PK=new TextDecoder,z=(K,U,q)=>{if(K)switch(U){case 1:return new Int8Array(q);case 2:return new Int16Array(q);case 4:return new Int32Array(q);default:throw new RangeError(`Invalid newArray parameter element_bytes:${U}`)}switch(U){case 1:return new Uint8Array(q);case 2:return new Uint16Array(q);case 4:return new Uint32Array(q);default:throw new RangeError(`Invalid newArray parameter element_bytes:${U}`)}},YK=(K,U,q)=>{return K.slice(U,U+q)};class m{#K;#U;#q;constructor(K=1024){this.#K=1,this.#U={signed:!0,bytes:4,array:z(!0,4,K)},this.#q={signed:!0,bytes:4,array:z(!0,4,K)},this.#U.array[0]=1,this.#q.array[0]=0,this.initBase(this.#U.array,1,this.#U.array.length),this.initCheck(this.#q.array,1,this.#q.array.length)}initBase(K,U,q){for(let H=U;H<q;H++)K[H]=-H+1;if(0<this.#q.array[this.#q.array.length-1]){let H=this.#q.array.length-2;while(0<this.#q.array[H])H--;K[U]=-H}}initCheck(K,U,q){for(let H=U;H<q;H++)K[H]=-H-1}realloc(K){let U=K*2,q=z(this.#U.signed,this.#U.bytes,U);this.initBase(q,this.#U.array.length,U),q.set(this.#U.array),this.#U.array=q;let H=z(this.#q.signed,this.#q.bytes,U);this.initCheck(H,this.#q.array.length,U),H.set(this.#q.array),this.#q.array=H}getBaseBuffer(){return this.#U.array}getCheckBuffer(){return this.#q.array}loadBaseBuffer(K){return this.#U.array=K,this}loadCheckBuffer(K){return this.#q.array=K,this}size(){return Math.max(this.#U.array.length,this.#q.array.length)}getBase(K){if(this.#U.array.length-1<K)return-K+1;return this.#U.array[K]}getCheck(K){if(this.#q.array.length-1<K)return-K-1;return this.#q.array[K]}setBase(K,U){if(this.#U.array.length-1<K)this.realloc(K);this.#U.array[K]=U}setCheck(K,U){if(this.#q.array.length-1<K)this.realloc(K);this.#q.array[K]=U}setFirstUnusedNode(K){this.#K=K}getFirstUnusedNode(){return this.#K}shrink(){let K=Math.max(this.#U.array.length,this.#q.array.length)-1;while(0<=this.#q.array[K])K--;this.#U.array=this.#U.array.subarray(0,K+2),this.#q.array=this.#q.array.subarray(0,K+2)}calc(){let K=0,U=this.#q.array.length;for(let q=0;q<U;q++)if(this.#q.array[q]<0)K++;return{all:U,unused:K,efficiency:(U-K)/U}}dump(){let K="",U="";for(let q of this.#U.array)K+=` ${q}`;for(let q of this.#q.array)U+=` ${q}`;return console.log(`base:${K}`),console.log(`check:${U}`),`base:${K} check:${U}`}}class p{#K;#U;constructor(K=1024){this.#K=new m(K),this.#U=[]}append(K,U){return this.#U.push({k:K,v:U}),this}build(K=this.#U,U=!1){if(K==null)return new A(this.#K);let q=K.map((H)=>{return{k:S.encode(H.k+"\x00"),v:H.v}});if(U)this.#U=q;else this.#U=q.sort((H,J)=>{let Q=H.k,X=J.k,Z=Math.min(Q.length,X.length);for(let $=0;$<Z;$++){if(Q[$]===X[$])continue;return Q[$]-X[$]}return Q.length-X.length});return this.#q(0,0,0,this.#U.length),new A(this.#K)}#q(K,U,q,H){let J=this.getChildrenInfo(U,q,H),Q=this.findAllocatableBase(J);this.setBufferController(K,J,Q);for(let X=0;X<J.length;X=X+3){let Z=J[X];if(Z===0)continue;let $=J[X+1],W=J[X+2],F=Q+Z;this.#q(F,U+1,$,W)}}getChildrenInfo(K,U,q){let H=this.#U[U].k[K],J=new Int32Array(q*3),Q=0;J[Q++]=Number.parseInt(`${H}`),J[Q++]=U;let X=U,Z=U;for(;X<U+q;X++){let $=this.#U[X].k[K];if(H!==$)J[Q++]=X-Z,J[Q++]=Number.parseInt(`${$}`),J[Q++]=X,H=$,Z=X}return J[Q++]=X-Z,J=J.subarray(0,Q),J}setBufferController(K,U,q){let H=this.#K;H.setBase(K,q);for(let J=0;J<U.length;J=J+3){let Q=U[J],X=q+Q,Z=-H.getBase(X),$=-H.getCheck(X);if(X!==H.getFirstUnusedNode())H.setCheck(Z,-$);else H.setFirstUnusedNode($);H.setBase($,-Z);let W=K;if(H.setCheck(X,W),Q===0){let F=U[J+1],P=this.#U[F].v;if(P==null)P=0;let Y=-P-1;H.setBase(X,Y)}}}findAllocatableBase(K){let U=this.#K,q,H=U.getFirstUnusedNode();while(!0){if(q=H-K[0],q<0){H=-U.getCheck(H);continue}let J=!0;for(let Q=0;Q<K.length;Q=Q+3){let X=K[Q],Z=q+X;if(!this.isUnusedNode(Z)){H=-U.getCheck(H),J=!1;break}}if(J)return q}}isUnusedNode(K){let q=this.#K.getCheck(K);if(K===0)return!1;if(q<0)return!0;return!1}}class A{#K;constructor(K){this.#K=K,this.#K.shrink()}contain(K){let U=K,q=this.#K;U+="\x00";let H=S.encode(U),J=0,Q=-1;for(let X=0;X<H.length;X++){let Z=H[X];if(Q=this.traverse(J,Z),Q===-1)return!1;if(q.getBase(Q)<=0)return!0;J=Q}return!1}lookup(K){let U=K;U+="\x00";let q=S.encode(U),H=0,J=-1;for(let X=0;X<q.length;X++){let Z=q[X];if(J=this.traverse(H,Z),J===-1)return-1;H=J}let Q=this.#K.getBase(J);if(Q<=0)return-Q-1;return-1}commonPrefixSearch(K){let U=S.encode(K),q=[],H=0,J=-1;for(let Q=0;Q<U.length;Q++){let X=U[Q];if(J=this.traverse(H,X),J!==-1){H=J;let Z=this.traverse(J,0);if(Z!==-1){let $=this.#K.getBase(Z),W={k:"",v:0};if($<=0)W.v=-$-1;W.k=PK.decode(YK(U,0,Q+1)),q.push(W)}continue}break}return q}traverse(K,U){let q=this.#K.getBase(K)+U;if(this.#K.getCheck(q)===K)return q;return-1}size(){return this.#K.size()}calc(){return this.#K.calc()}dump(){return this.#K.dump()}}var NK={builder:(K=1024)=>{return new p(K)},load:(K,U)=>{let q=new m(0);return q.loadBaseBuffer(K),q.loadCheckBuffer(U),new A(q)}};var j=NK;class b{forward_dimension;backward_dimension;#K;constructor(K,U){this.forward_dimension=K,this.backward_dimension=U,this.#K=new Int16Array(K*U+2),this.#K[0]=K,this.#K[1]=U}put(K,U,q){let H=K*this.backward_dimension+U+2;if(this.#K.length<H+1)throw"ConnectionCosts buffer overflow";this.#K[H]=q}get(K,U){let q=K*this.backward_dimension+U+2;if(this.#K.length<q+1)throw"ConnectionCosts buffer overflow";return this.#K[q]}loadConnectionCosts(K){this.forward_dimension=K[0],this.backward_dimension=K[1],this.#K=K}}var B=b;var EK=new TextEncoder,GK=new TextDecoder;class l{buffer;position=0;constructor(K){if(K===void 0)this.buffer=new Uint8Array(1048576),this.position=0;else if(typeof K==="number"){let U=K;this.buffer=new Uint8Array(U),this.position=0}else if(K instanceof Uint8Array)this.buffer=K,this.position=0;else throw`${typeof K} is invalid parameter type for ByteBuffer constructor`}size(){return this.buffer.length}reallocate(){let K=new Uint8Array(this.buffer.length*2);K.set(this.buffer),this.buffer=K}shrink(){return this.buffer=this.buffer.subarray(0,this.position),this.buffer}put(K){if(this.buffer.length<this.position+1)this.reallocate();if(typeof K==="boolean")this.buffer[this.position++]=K?1:0;else this.buffer[this.position++]=K}get(K=null){let U=K;if(U==null)U=this.position,this.position+=1;if(this.buffer.length<U+1)return 0;return this.buffer[U]}putShort(K){if(65535<K)throw`${K} is over short value`;let U=255&K,q=(65280&K)>>8;this.put(U),this.put(q)}getShort(K){let U=K;if(U==null)U=this.position,this.position+=2;if(this.buffer.length<U+2)return 0;let q=this.buffer[U],J=(this.buffer[U+1]<<8)+q;if(J&32768)J=-(J-1^65535);return J}putInt(K){if(4294967295<K)throw`${K} is over integer value`;let U=255&K,q=(65280&K)>>8,H=(16711680&K)>>16,J=(4278190080&K)>>24;this.put(U),this.put(q),this.put(H),this.put(J)}getInt(K=null){let U=K;if(U==null)U=this.position,this.position+=4;if(this.buffer.length<U+4)return 0;let q=this.buffer[U],H=this.buffer[U+1],J=this.buffer[U+2];return(this.buffer[U+3]<<24)+(J<<16)+(H<<8)+q}readInt(){let K=this.position;return this.position+=4,this.getInt(K)}putString(K){let U=EK.encode(K);if(!U)throw new Error("bytes null.");for(let q of U)this.put(q);this.put(0)}getString(K=this.position){let U=K,q=[],H;while(U<this.buffer.length){if(H=this.get(U++),H===0)break;q.push(H)}return this.position=U,GK.decode(new Uint8Array(q))}getUtf32(K=null){let U=K;if(U==null)U=this.position,this.position+=4;if(this.buffer.length<U+4)return 0;let q=this.buffer.subarray(U,U+4);return new DataView(q.buffer).getUint32(0,!1)}getBool(K=null){let U=K;if(U==null)U=this.position,this.position+=1;if(this.buffer.length<U+1)return!1;return Boolean(this.buffer[U])}}var E=l;class u{dictionary;target_map;pos_buffer;constructor(){this.dictionary=new E(10485760),this.target_map=new Map,this.pos_buffer=new E(10485760)}buildDictionary(K){let U={};for(let q=0;q<K.length;q++){let H=K[q];if(H.length<4)continue;let J=H[0],Q=Number.parseInt(H[1]),X=Number.parseInt(H[2]),Z=Number.parseInt(H[3]),$=H.slice(4).join(",");if(!Number.isFinite(Q)||!Number.isFinite(X)||!Number.isFinite(Z))console.log(H);let W=this.put(Q,X,Z,J,$);U[W]=J}return this.dictionary.shrink(),this.pos_buffer.shrink(),U}put(K,U,q,H,J){let Q=this.dictionary.position,X=this.pos_buffer.position;return this.dictionary.putShort(K),this.dictionary.putShort(U),this.dictionary.putShort(q),this.dictionary.putInt(X),this.pos_buffer.putString(`${H},${J}`),Q}addMapping(K,U){let q=this.target_map.get(K);if(q==null)q=[];q.push(U),this.target_map.set(K,q)}targetMapToBuffer(){let K=new E;K.putInt(Object.keys(this.target_map).length);for(let U in this.target_map){let q=Number.parseInt(U),H=this.target_map.get(q);if(!H)continue;let J=H.length;K.putInt(q),K.putInt(J);for(let Q of H)K.putInt(Q)}return K.shrink()}loadDictionary(K){return this.dictionary=new E(K),this}loadPosVector(K){return this.pos_buffer=new E(K),this}loadTargetMap(K){let U=new E(K);U.position=0,this.target_map=new Map,U.readInt();while(!0){if(U.buffer.length<U.position+1)break;let q=U.readInt(),H=U.readInt();for(let J=0;J<H;J++){let Q=U.readInt();this.addMapping(q,Q)}}return this}getFeatures(K){if(Number.isNaN(K))return null;let U=this.dictionary.getInt(K+6);return this.pos_buffer.getString(U)}}var L=u;class R{str;#K;length;constructor(K){this.str=K,this.#K=[];let U=K.length;for(let q=0;q<U;q++){let H=K.charAt(q);if(this.#K.push(q),R.isSurrogatePair(H))q++}this.length=this.#K.length}slice(K){if(this.#K.length<=K)return"";let U=this.#K[K];return this.str.slice(U)}charAt(K){if(this.str.length<=K)return"";let U=this.#K[K],q=this.#K[K+1];if(q==null)return this.str.slice(U);return this.str.slice(U,q)}charCodeAt(K){if(this.#K.length<=K)return Number.NaN;let U=this.#K[K],q=this.str.charCodeAt(U),H;if(q>=55296&&q<=56319&&U<this.str.length){if(H=this.str.charCodeAt(U+1),H>=56320&&H<=57343)return(q-55296)*1024+H-56320+65536}return q}toString(){return this.str}add(K){return new R(this.str+K.str)}append(K){return new R(this.str+K)}static isSurrogatePair(K){let U=K.charCodeAt(0);if(U>=55296&&U<=56319)return!0;return!1}}var D=R;class f{class_id;class_name;is_always_invoke;is_grouping;max_length;constructor(K,U,q,H,J){this.class_id=K,this.class_name=U,this.is_always_invoke=q,this.is_grouping=H,this.max_length=J}}var v=f;class h{#K;#U;constructor(){this.#K=[],this.#U=new Map}static load(K){let U=new h,q=[],H=new E(K);while(H.position+1<H.size()){let J=H.getBool(),Q=H.getBool(),X=H.getInt(),Z=H.getString();q.push(new v(q.length,Z,J,Q,X))}return U.init(q),U}init(K){if(K==null)return;let U=K.length;for(let q=0;q<U;q++){let H=K[q];this.#K[q]=H,this.#U.set(H.class_name,q)}}getCharacterClass(K){return this.#K[K]}lookup(K){let U=this.#U.get(K);if(U==null)return null;return U}toBuffer(){let K=new E;for(let U=0;U<this.#K.length;U++){let q=this.#K[U];K.put(q.is_always_invoke),K.put(q.is_grouping),K.putInt(q.max_length),K.putString(q.class_name)}return K.shrink(),K.buffer}}var C=h;var k="DEFAULT";class y{character_category_map;compatible_category_map;invoke_definition_map;constructor(){this.character_category_map=new Uint8Array(65536),this.compatible_category_map=new Uint32Array(65536),this.invoke_definition_map=null}load(K,U,q){let H=new y;return H.character_category_map=K,H.compatible_category_map=U,H.invoke_definition_map=C.load(q),H}static parseCharCategory(K,U){let q=U[1],H=Number.parseInt(U[2]),J=Number.parseInt(U[3]),Q=Number.parseInt(U[4]);if(!Number.isFinite(H)||H!==0&&H!==1)return console.log(`char.def parse error. INVOKE is 0 or 1 in:${H}`),null;if(!Number.isFinite(J)||J!==0&&J!==1)return console.log(`char.def parse error. GROUP is 0 or 1 in:${J}`),null;if(!Number.isFinite(Q)||Q<0)return console.log(`char.def parse error. LENGTH is 1 to n:${Q}`),null;return new v(K,q,H===1,J===1,Q)}static parseCategoryMapping(K){let U=Number.parseInt(K[1]);if(!Number.isFinite(U)||U<0||U>65535)console.log(`char.def parse error. CODE is invalid:${U}`);return{start:U,default:K[2],compatible:3<K.length?K.slice(3):[]}}static parseRangeCategoryMapping(K){let U=Number.parseInt(K[1]),q=Number.parseInt(K[2]);if(!Number.isFinite(U)||U<0||U>65535)console.log(`char.def parse error. CODE is invalid:${U}`);if(!Number.isFinite(q)||q<0||q>65535)console.log(`char.def parse error. CODE is invalid:${q}`);return{start:U,end:q,default:K[3],compatible:4<K.length?K.slice(4):[]}}initCategoryMappings(K){if(!this.invoke_definition_map)throw new Error("CharacterDefinition.initCategoryMappings: invoke_definition_map is null");let U=0;if(K!=null){let J=K.length;for(let Q=0;Q<J;Q++){let X=K[Q];for(U=X.start;U<=(X.end||X.start);U++){let Z=this.invoke_definition_map.lookup(X.default);if(Z==null)throw new Error("CharacterDefinition.initCategoryMappings: invoke_definition_map.lookup() returns null");this.character_category_map[U]=Z;for(let $=0;$<X.compatible.length;$++){let W=this.compatible_category_map[U],F=X.compatible[$];if(F==null)continue;let P=this.invoke_definition_map.lookup(F);if(P==null)continue;let Y=1<<P;W=W|Y,this.compatible_category_map[U]=W}}}}let q=this.invoke_definition_map.lookup(k);if(q==null)return;let H=this.compatible_category_map.length;for(U=0;U<H;U++)if(this.character_category_map[U]===0)this.character_category_map[U]=1<<q}lookupCompatibleCategory(K){let U=[];if(!this.invoke_definition_map)throw new Error("CharacterDefinition.lookupCompatibleCategory: invoke_definition_map is null");let q=K.charCodeAt(0),H=null;if(q<this.compatible_category_map.length)H=this.compatible_category_map[q];if(H==null||H===0)return U;for(let J=0;J<32;J++)if(H<<31-J>>>31===1){let Q=this.invoke_definition_map.getCharacterClass(J);if(Q==null)continue;U.push(Q)}return U}lookup(K){if(!this.invoke_definition_map)throw new Error("CharacterDefinition.lookup: invoke_definition_map is null");let U=null,q=K.charCodeAt(0);if(D.isSurrogatePair(K))U=this.invoke_definition_map.lookup(k);else if(q<this.character_category_map.length)U=this.character_category_map[q];if(U==null)U=this.invoke_definition_map.lookup(k);return this.invoke_definition_map.getCharacterClass(U)}}var O=y;class s extends L{#K=null;characterDefinition(K){return this.#K=K,this}lookup(K){if(this.#K==null)throw new Error("CharacterDefinition is not set");return this.#K.lookup(K)}lookupCompatibleCategory(K){if(this.#K==null)throw new Error("CharacterDefinition is not set");return this.#K.lookupCompatibleCategory(K)}loadUnknownDictionaries(K,U,q,H,J,Q){this.loadDictionary(K),this.loadPosVector(U),this.loadTargetMap(q),this.#K=new O().load(H,J,Q)}}var w=s;class c{trie;token_info_dictionary;connection_costs;unknown_dictionary;constructor(K,U,q,H){this.trie=K??j.builder(0).build([{k:"",v:1}]),this.token_info_dictionary=U??new L,this.connection_costs=q??new B(0,0),this.unknown_dictionary=H??new w}loadTrie(K,U){return this.trie=j.load(K,U),this}loadTokenInfoDictionaries(K,U,q){return this.token_info_dictionary.loadDictionary(K),this.token_info_dictionary.loadPosVector(U),this.token_info_dictionary.loadTargetMap(q),this}loadConnectionCosts(K){return this.connection_costs.loadConnectionCosts(K),this}loadUnknownDictionaries(K,U,q,H,J,Q){return this.unknown_dictionary.loadUnknownDictionaries(K,U,q,H,J,Q),this}}var x=c;var MK=/^(\w+)\s+(\d)\s+(\d)\s+(\d)/,OK=/^(0x[0-9A-F]{4})(?:\s+([^#\s]+))(?:\s+([^#\s]+))*/,LK=/^(0x[0-9A-F]{4})\.\.(0x[0-9A-F]{4})(?:\s+([^#\s]+))(?:\s+([^#\s]+))*/;class d{char_def;character_category_definition;category_mapping;constructor(){this.char_def=new O,this.char_def.invoke_definition_map=new C,this.character_category_definition=[],this.category_mapping=[]}putLine(K){let U=MK.exec(K);if(U!=null){let J=this.character_category_definition.length,Q=O.parseCharCategory(J,U);if(Q==null)return;this.character_category_definition.push(Q);return}let q=OK.exec(K);if(q!=null){let J=O.parseCategoryMapping(q);this.category_mapping.push(J)}let H=LK.exec(K);if(H!=null){let J=O.parseRangeCategoryMapping(H);this.category_mapping.push(J)}}build(){if(!this.char_def||!this.char_def.invoke_definition_map)throw new Error("No data to build.");return this.char_def.invoke_definition_map.init(this.character_category_definition),this.char_def.initCategoryMappings(this.category_mapping),this.char_def}}var o=d;class t{lines;connection_cost;constructor(){this.lines=0,this.connection_cost=null}putLine(K){if(this.lines===0||!this.connection_cost){let Q=K.split(" "),X=Number.parseInt(Q[0]),Z=Number.parseInt(Q[1]);if(X<0||Z<0)throw"Parse error of matrix.def";return this.connection_cost=new B(X,Z),this.lines++,this}if(!this.connection_cost)throw"connection_cost is null";let U=K.split(" ");if(U.length!==3)return this;let q=Number.parseInt(U[0]),H=Number.parseInt(U[1]),J=Number.parseInt(U[2]);if(q<0||H<0||!Number.isFinite(q)||!Number.isFinite(H)||this.connection_cost.forward_dimension<=q||this.connection_cost.backward_dimension<=H)throw"Parse error of matrix.def";return this.connection_cost.put(q,H,J),this.lines++,this}build(){if(!this.connection_cost)throw"No data to build.";return this.connection_cost}}var _=t;class a{#K;#U;#q;#H;constructor(){this.#K=[],this.#U=[],this.#q=new _,this.#H=new o}addTokenInfoDictionary(K){let U=K.split(",");return this.#K.push(U),this}putCostMatrixLine(K){return this.#q.putLine(K),this}putCharDefLine(K){return this.#H.putLine(K),this}putUnkDefLine(K){return this.#U.push(K.split(",")),this}build(){let K=this.buildTokenInfoDictionary();return new x(K.trie,K.token_info_dictionary,this.#q.build(),this.buildUnknownDictionary())}buildTokenInfoDictionary(){let K=new L,U=K.buildDictionary(this.#K),q=this.buildDoubleArray();for(let H in U){let J=U[H],Q=q.lookup(J);K.addMapping(Q,Number.parseInt(H))}return{trie:q,token_info_dictionary:K}}buildUnknownDictionary(){let K=new w,U=K.buildDictionary(this.#U),q=this.#H.build();if(!q||!q.invoke_definition_map)throw new Error("CharacterDefinition is not set");K.characterDefinition(q);for(let H in U){let J=U[H],Q=q.invoke_definition_map.lookup(J);if(!Q)throw new Error(`Class name not found: ${J}`);K.addMapping(Q,Number.parseInt(H))}return K}buildDoubleArray(){let K=0,U=this.#K.map((H)=>{return{k:H[0],v:K++}});return j.builder(1048576).build(U)}}var n=a;class i{formatEntry(K,U,q,H){return{word_id:K,word_type:q,word_position:U,surface_form:H[0],pos:H[1],pos_detail_1:H[2],pos_detail_2:H[3],pos_detail_3:H[4],conjugated_type:H[5],conjugated_form:H[6],basic_form:H[7],reading:H[8],pronunciation:H[9]}}formatUnknownEntry(K,U,q,H,J){return{word_id:K,word_type:q,word_position:U,surface_form:J,pos:H[1],pos_detail_1:H[2],pos_detail_2:H[3],pos_detail_3:H[4],conjugated_type:H[5],conjugated_form:H[6],basic_form:H[7]}}}var r=i;class e{name;cost;start_pos;length;left_id;right_id;prev;surface_form;shortest_cost;type;constructor(K,U,q,H,J,Q,X,Z){this.name=K,this.cost=U,this.start_pos=q,this.length=H,this.left_id=Q,this.right_id=X,this.prev=null,this.surface_form=Z,this.shortest_cost=J==="BOS"?0:Number.MAX_VALUE,this.type=J}}var V=e;class KK{nodes_end_at;eos_pos;constructor(){this.nodes_end_at=[],this.nodes_end_at[0]=[new V(-1,0,0,0,"BOS",0,0,"")],this.eos_pos=1}append(K){let U=K.start_pos+K.length-1;if(this.eos_pos<U)this.eos_pos=U;let q=this.nodes_end_at[U]??[];q.push(K),this.nodes_end_at[U]=q}appendEos(){let K=this.nodes_end_at.length;this.eos_pos++,this.nodes_end_at[K]=[new V(-1,0,this.eos_pos,0,"EOS",0,0,"")]}}var UK=KK;class qK{#K;#U;#q;constructor(K){this.#K=K.trie,this.#U=K.token_info_dictionary,this.#q=K.unknown_dictionary}build(K){let U=new UK,q=new D(K),H=q.length;for(let J=0;J<H;J++){let Q=q.slice(J),X=this.#K.commonPrefixSearch(Q),Z=X.length;for(let F=0;F<Z;F++){let P=X[F].v,Y=X[F].k,I=this.#U.target_map.get(P);if(!I)throw new Error("TokenInfo dictionary is broken");for(let G of I){let M=this.#U.dictionary.getShort(G),N=this.#U.dictionary.getShort(G+2),T=this.#U.dictionary.getShort(G+4);U.append(new V(G,T,J+1,Y.length,"KNOWN",M,N,Y))}}let $=Q.charAt(0),W=this.#q.lookup($);if(!X?.length||W.is_always_invoke){let F=$,P=Q.length;if(W.is_grouping&&P>1){let M=W.class_name;for(let N=1;N<P;N++){let T=Q.charAt(N);if(this.#q.lookup(T).class_name!==M)break;F+=T}}let Y=this.#q.target_map.get(W.class_id);if(!Y)throw new Error("Unknown dictionary is broken");let I=Y.length,G=this.#q.dictionary;for(let M=0;M<I;M++){let N=Y[M];U.append(new V(N,G.getShort(N+4),J+1,F.length,"UNKNOWN",G.getShort(N),G.getShort(N+2),F))}}}return U.appendEos(),U}}var HK=qK;class JK{#K;constructor(K){this.#K=K}search(K){let U=K;return U=this.#U(U),this.#q(U)}#U(K){let U=1;for(U=1;U<=K.eos_pos;U++){let q=K.nodes_end_at[U];if(q==null)continue;for(let H of q){let J=Number.MAX_VALUE,Q=null,X=H.start_pos-1;if(!(X in K.nodes_end_at))continue;let Z=K.nodes_end_at[X];for(let $ of Z){let W;if(H.left_id==null||$.right_id==null)console.log("Left or right is null"),W=0;else W=this.#K.get($.right_id,H.left_id);let F=$.shortest_cost+W+H.cost;if(F<J)Q=$,J=F}H.prev=Q,H.shortest_cost=J}}return K}#q(K){let U=[],H=K.nodes_end_at[K.nodes_end_at.length-1][0].prev;if(H==null)return[];while(H.type!=="BOS"){if(U.push(H),H.prev==null)return[];H=H.prev}return U.reverse()}}var QK=JK;class g{#K;#U;#q;#H;#J;constructor(K){this.#K=K.token_info_dictionary,this.#U=K.unknown_dictionary,this.#q=new HK(K),this.#H=new QK(K.connection_costs),this.#J=new r}static splitByPunctuation(K){let U=K.matchAll(/\u3001|\u3002/g),q=[],H=0;for(let J of U){let Q=J.index;q.push(K.slice(H,Q+1)),H=Q+1}if(H<K.length)q.push(K.slice(H));return q}tokenize(K){let U=g.splitByPunctuation(K),q=[];for(let H of U)this.#Q(H,q);return q}#Q(K,U=[]){let q=this.#q.build(K),H=this.#H.search(q),J=U.length>0?U[U.length-1].word_position:0;for(let Q of H)U.push(this.#X(Q,J));return U}#X(K,U){let q=K.type==="KNOWN"?this.#K.getFeatures(K.name):this.#U.getFeatures(K.name),H=q?q.split(","):[];if(K.type==="UNKNOWN")return this.#J.formatUnknownEntry(K.name,U+K.start_pos,K.type,H,K.surface_form);return this.#J.formatEntry(K.name,U+K.start_pos,K.type,H)}}var XK=g;import{existsSync as VK,readFileSync as jK}from"fs";import RK from"path";import IK from"zlib";class ZK{#K;#U;constructor(K="dict/"){this.#K=new x,this.#U=K}#q=(K)=>new Promise((U,q)=>{if(!VK(K))return q(new Error(`${K} does not exist`));let H=jK(K);IK.gunzip(new Uint8Array(H),(J,Q)=>{if(J)return q(J);let X=new Uint8Array(Q);U(X.buffer)})});load(K){Promise.all(["base.dat.gz","check.dat.gz","tid.dat.gz","tid_pos.dat.gz","tid_map.dat.gz","cc.dat.gz","unk.dat.gz","unk_pos.dat.gz","unk_map.dat.gz","unk_char.dat.gz","unk_compat.dat.gz","unk_invoke.dat.gz"].map((U)=>this.#q(RK.join(this.#U,U)))).then((U)=>{this.#K.loadTrie(new Int32Array(U[0]),new Int32Array(U[1])),this.#K.loadTokenInfoDictionaries(new Uint8Array(U[2]),new Uint8Array(U[3]),new Uint8Array(U[4])),this.#K.loadConnectionCosts(new Int16Array(U[5])),this.#K.loadUnknownDictionaries(new Uint8Array(U[6]),new Uint8Array(U[7]),new Uint8Array(U[8]),new Uint8Array(U[9]),new Uint32Array(U[10]),new Uint8Array(U[11])),K(null,this.#K)}).catch((U)=>{K(U,this.#K)})}}var $K=ZK;class WK{#K;constructor(K={}){this.#K=new $K(K.dicPath)}build(K){this.#K.load((U,q)=>{K(U,new XK(q))})}}var FK=WK;var A8={builder:(K={})=>{return new FK(K)},dictionaryBuilder:()=>{return new n}};export{A8 as default,FK as TokenizerBuilder,n as DictionaryBuilder};

//# debugId=9ED2D62EBA28213964756E2164756E21
//# sourceMappingURL=index.min.js.map
