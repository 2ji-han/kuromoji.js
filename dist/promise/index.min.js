// @bun
var R=(K,$,J)=>{if(K)switch($){case 1:return new Int8Array(J);case 2:return new Int16Array(J);case 4:return new Int32Array(J);default:throw new RangeError(`Invalid parameter: ${$}`)}switch($){case 1:return new Uint8Array(J);case 2:return new Uint16Array(J);case 4:return new Uint32Array(J);default:throw new RangeError(`Invalid parameter: ${$}`)}};var y="\x00",k=0,G=0,j=-1,O=new TextEncoder,j8=new TextDecoder;class g{#K;#$;#q;constructor(K=1024){this.#K=G+1,this.#$={signed:!0,bytes:4,array:R(!0,4,K)},this.#q={signed:!0,bytes:4,array:R(!0,4,K)},this.#$.array[G]=1,this.#q.array[G]=G,this.#J(this.#$.array,G+1,this.#$.array.length),this.#Q(this.#q.array,G+1,this.#q.array.length)}#J(K,$,J){for(let q=$;q<J;q++)K[q]=-q+1;if(0<this.#q.array[this.#q.array.length-1]){let q=this.#q.array.length-2;while(0<this.#q.array[q])q--;K[$]=-q}}#Q(K,$,J){for(let q=$;q<J;q++)K[q]=-q-1}#X(K){let $=K*2,J=R(this.#$.signed,this.#$.bytes,$);this.#J(J,this.#$.array.length,$),J.set(this.#$.array),this.#$.array=J;let q=R(this.#q.signed,this.#q.bytes,$);this.#Q(q,this.#q.array.length,$),q.set(this.#q.array),this.#q.array=q}getBaseBuffer(){return this.#$.array}getCheckBuffer(){return this.#q.array}loadBaseBuffer(K){return this.#$.array=K,this}loadCheckBuffer(K){return this.#q.array=K,this}size(){return Math.max(this.#$.array.length,this.#q.array.length)}getBase(K){if(this.#$.array.length-1<K)return-K+1;return this.#$.array[K]}getCheck(K){if(this.#q.array.length-1<K)return-K-1;return this.#q.array[K]}setBase(K,$){if(this.#$.array.length-1<K)this.#X(K);this.#$.array[K]=$}setCheck(K,$){if(this.#q.array.length-1<K)this.#X(K);this.#q.array[K]=$}setFirstUnusedNode(K){this.#K=K}getFirstUnusedNode(){return this.#K}shrink(){let K=Math.max(this.#$.array.length,this.#q.array.length)-1;while(0<=this.#q.array[K])K--;this.#$.array=this.#$.array.subarray(0,K+2),this.#q.array=this.#q.array.subarray(0,K+2)}calc(){let K=0,$=this.#q.array.length;for(let J=0;J<$;J++)if(this.#q.array[J]<0)K++;return{all:$,unused:K,efficiency:($-K)/$}}dump(){let K="",$="";for(let J of this.#$.array)K+=` ${J}`;for(let J of this.#q.array)$+=` ${J}`;return console.log(`base:${K}`),console.log(`check:${$}`),`base:${K} check:${$}`}}class f{#K;#$;constructor(K=1024){this.#K=new g(K),this.#$=[]}append(K,$){return this.#$.push({k:K,v:$}),this}build(K=this.#$,$=!1){if(K==null)return new v(this.#K);let J=K.map((q)=>{return{k:O.encode(q.k+y),v:q.v}});if($)this.#$=J;else this.#$=J.sort((q,Q)=>{let X=q.k,Z=Q.k,H=Math.min(X.length,Z.length);for(let P=0;P<H;P++){if(X[P]===Z[P])continue;return X[P]-Z[P]}return X.length-Z.length});return this.#q(G,0,0,this.#$.length),new v(this.#K)}#q(K,$,J,q){let Q=this.#J($,J,q),X=this.#X(Q);this.#Q(K,Q,X);for(let Z=0;Z<Q.length;Z=Z+3){let H=Q[Z];if(H===k)continue;let P=Q[Z+1],W=Q[Z+2],Y=X+H;this.#q(Y,$+1,P,W)}}#J(K,$,J){let q=this.#$[$].k[K],Q=new Int32Array(J*3),X=0;Q[X++]=Number.parseInt(`${q}`),Q[X++]=$;let Z=$,H=$;for(;Z<$+J;Z++){let P=this.#$[Z].k[K];if(q!==P)Q[X++]=Z-H,Q[X++]=Number.parseInt(`${P}`),Q[X++]=Z,q=P,H=Z}return Q[X++]=Z-H,Q=Q.subarray(0,X),Q}#Q(K,$,J){let q=this.#K;q.setBase(K,J);for(let Q=0;Q<$.length;Q=Q+3){let X=$[Q],Z=J+X,H=-q.getBase(Z),P=-q.getCheck(Z);if(Z!==q.getFirstUnusedNode())q.setCheck(H,-P);else q.setFirstUnusedNode(P);q.setBase(P,-H);let W=K;if(q.setCheck(Z,W),X===k){let Y=$[Q+1],U=this.#$[Y].v;if(U==null)U=0;let L=-U-1;q.setBase(Z,L)}}}#X(K){let $=this.#K,J,q=$.getFirstUnusedNode();while(!0){if(J=q-K[0],J<0){q=-$.getCheck(q);continue}let Q=!0;for(let X=0;X<K.length;X=X+3){let Z=K[X],H=J+Z;if(!this.#Z(H)){q=-$.getCheck(q),Q=!1;break}}if(Q)return J}}#Z(K){let J=this.#K.getCheck(K);if(K===G)return!1;if(J<0)return!0;return!1}}class v{#K;constructor(K){this.#K=K,this.#K.shrink()}contain(K){let $=K,J=this.#K;$+=y;let q=O.encode($),Q=G,X=j;for(let Z=0;Z<q.length;Z++){let H=q[Z];if(X=this.#$(Q,H),X===j)return!1;if(J.getBase(X)<=0)return!0;Q=X}return!1}lookup(K){let $=K;$+=y;let J=O.encode($),q=G,Q=j;for(let Z=0;Z<J.length;Z++){let H=J[Z];if(Q=this.#$(q,H),Q===j)return j;q=Q}let X=this.#K.getBase(Q);if(X<=0)return-X-1;return j}commonPrefixSearch(K){let $=O.encode(K),J=[],q=G,Q=j;for(let X=0;X<$.length;X++){let Z=$[X];if(Q=this.#$(q,Z),Q!==j){q=Q;let H=this.#$(Q,k);if(H!==j){let P=this.#K.getBase(H),W={k:"",v:0};if(P<=0)W.v=-P-1;W.k=j8.decode($.slice(0,X+1)),J.push(W)}continue}break}return J}#$(K,$){let J=this.#K.getBase(K)+$;if(this.#K.getCheck(J)===K)return J;return j}size(){return this.#K.size()}calc(){return this.#K.calc()}dump(){return this.#K.dump()}}var S={builder:(K=1024)=>{return new f(K)},load:(K,$)=>{let J=new g(0);return J.loadBaseBuffer(K),J.loadCheckBuffer($),new v(J)}};class c{forward_dimension;backward_dimension;#K;constructor(K,$){this.forward_dimension=K,this.backward_dimension=$,this.#K=new Int16Array(K*$+2),this.#K[0]=K,this.#K[1]=$}put(K,$,J){let q=K*this.backward_dimension+$+2;if(this.#K.length<q+1)throw"ConnectionCosts buffer overflow";this.#K[q]=J}get(K,$){let J=K*this.backward_dimension+$+2;if(this.#K.length<J+1)throw"ConnectionCosts buffer overflow";return this.#K[J]}loadConnectionCosts(K){this.forward_dimension=K[0],this.backward_dimension=K[1],this.#K=K}}var D=c;var F8=new TextEncoder,M8=new TextDecoder;class s{#K;#$=0;get buffer(){return this.#K}set buffer(K){this.#K=K}get position(){return this.#$}set position(K){this.#$=K}constructor(K){if(K===void 0)this.#K=new Uint8Array(1048576),this.#$=0;else if(typeof K==="number")this.#K=new Uint8Array(K),this.#$=0;else if(K instanceof Uint8Array)this.#K=K,this.#$=0;else throw`${typeof K} is invalid parameter type`}size(){return this.#K.length}reallocate(){let K=new Uint8Array(this.#K.length*2);K.set(this.#K),this.#K=K}shrink(){return this.#K=this.#K.subarray(0,this.#$),this.#K}put(K){if(this.#K.length<this.#$+1)this.reallocate();if(typeof K==="boolean")this.#K[this.#$++]=K?1:0;else this.#K[this.#$++]=K}get(K=null){let $=K;if($==null)$=this.#$,this.#$+=1;if(this.#K.length<$+1)return 0;return this.#K[$]}putShort(K){if(65535<K)throw`${K} is over short value`;let $=255&K,J=(65280&K)>>8;this.put($),this.put(J)}getShort(K){let $=K;if($==null)$=this.#$,this.#$+=2;if(this.#K.length<$+2)return 0;let J=this.#K[$],Q=(this.#K[$+1]<<8)+J;if(Q&32768)Q=-(Q-1^65535);return Q}putInt(K){if(4294967295<K)throw`${K} is over integer value`;let $=255&K,J=(65280&K)>>8,q=(16711680&K)>>16,Q=(4278190080&K)>>24;this.put($),this.put(J),this.put(q),this.put(Q)}getInt(K=null){let $=K;if($==null)$=this.#$,this.#$+=4;if(this.#K.length<$+4)return 0;let J=this.#K[$],q=this.#K[$+1],Q=this.#K[$+2];return(this.#K[$+3]<<24)+(Q<<16)+(q<<8)+J}readInt(){let K=this.#$;return this.#$+=4,this.getInt(K)}putString(K){let $=F8.encode(K);for(let J of $)this.put(J);this.put(0)}getString(K=this.#$){let $=K,J=[],q;while($<this.#K.length){if(q=this.get($++),q===0)break;J.push(q)}return this.#$=$,M8.decode(new Uint8Array(J))}getUtf32(K=null){let $=K;if($==null)$=this.#$,this.#$+=4;if(this.#K.length<$+4)return 0;let J=this.#K.subarray($,$+4);return new DataView(J.buffer).getUint32(0,!1)}getBool(K=null){let $=K;if($==null)$=this.#$,this.#$+=1;if(this.#K.length<$+1)return!1;return Boolean(this.#K[$])}}var F=s;class d{dictionary;target_map;pos_buffer;constructor(){this.dictionary=new F(10485760),this.target_map=new Map,this.pos_buffer=new F(10485760)}buildDictionary(K){let $={};for(let J=0;J<K.length;J++){let q=K[J];if(q.length<4)continue;let Q=q[0],X=Number.parseInt(q[1]),Z=Number.parseInt(q[2]),H=Number.parseInt(q[3]),P=q.slice(4).join(",");if(!Number.isFinite(X)||!Number.isFinite(Z)||!Number.isFinite(H))console.log(q);let W=this.put(X,Z,H,Q,P);$[W]=Q}return this.dictionary.shrink(),this.pos_buffer.shrink(),$}put(K,$,J,q,Q){let X=this.dictionary.position,Z=this.pos_buffer.position;return this.dictionary.putShort(K),this.dictionary.putShort($),this.dictionary.putShort(J),this.dictionary.putInt(Z),this.pos_buffer.putString(`${q},${Q}`),X}addMapping(K,$){let J=this.target_map.get(K);if(J==null)J=[];J.push($),this.target_map.set(K,J)}targetMapToBuffer(){let K=new F;K.putInt(Object.keys(this.target_map).length);for(let $ in this.target_map){let J=Number.parseInt($),q=this.target_map.get(J);if(!q)continue;let Q=q.length;K.putInt(J),K.putInt(Q);for(let X of q)K.putInt(X)}return K.shrink()}loadDictionary(K){return this.dictionary=new F(K),this}loadPosVector(K){return this.pos_buffer=new F(K),this}loadTargetMap(K){let $=new F(K);$.position=0,this.target_map=new Map,$.readInt();while(!0){if($.buffer.length<$.position+1)break;let J=$.readInt(),q=$.readInt();for(let Q=0;Q<q;Q++){let X=$.readInt();this.addMapping(J,X)}}return this}getFeatures(K){if(Number.isNaN(K))return null;let $=this.dictionary.getInt(K+6);return this.pos_buffer.getString($)}}var z=d;class A{#K;#$;length;constructor(K){this.#K=K,this.#$=[];for(let $=0;$<K.length;$++){let J=K.charAt($);if(this.#$.push($),A.isSurrogatePair(J))$++}this.length=this.#$.length}slice(K){if(this.#$.length<=K)return"";let $=this.#$[K];return this.#K.slice($)}charAt(K){if(this.#K.length<=K)return"";let $=this.#$[K],J=this.#$[K+1];if(J==null)return this.#K.slice($);return this.#K.slice($,J)}charCodeAt(K){if(this.#$.length<=K)return Number.NaN;let $=this.#$[K],J=this.#K.charCodeAt($),q;if(J>=55296&&J<=56319&&$<this.#K.length){if(q=this.#K.charCodeAt($+1),q>=56320&&q<=57343)return(J-55296)*1024+q-56320+65536}return J}toString(){return this.#K}add(K){return new A(this.#K+K.#K)}append(K){return new A(this.#K+K)}static isSurrogatePair(K){let $=K.charCodeAt(0);if($>=55296&&$<=56319)return!0;return!1}}var w=A;class o{class_id;class_name;is_always_invoke;is_grouping;max_length;constructor(K,$,J,q,Q){this.class_id=K,this.class_name=$,this.is_always_invoke=J,this.is_grouping=q,this.max_length=Q}}var C=o;class p{#K;#$;constructor(){this.#K=[],this.#$=new Map}static load(K){let $=new p,J=[],q=new F(K);while(q.position+1<q.size()){let Q=q.getBool(),X=q.getBool(),Z=q.getInt(),H=q.getString();J.push(new C(J.length,H,Q,X,Z))}return $.init(J),$}init(K){if(K==null)return;let $=K.length;for(let J=0;J<$;J++){let q=K[J];this.#K[J]=q,this.#$.set(q.class_name,J)}}getCharacterClass(K){return this.#K[K]}lookup(K){let $=this.#$.get(K);if($==null)return null;return $}toBuffer(){let K=new F;for(let $=0;$<this.#K.length;$++){let J=this.#K[$];K.put(J.is_always_invoke),K.put(J.is_grouping),K.putInt(J.max_length),K.putString(J.class_name)}return K.shrink(),K.buffer}}var x=p;var b="DEFAULT";class l{character_category_map;compatible_category_map;invoke_definition_map;constructor(){this.character_category_map=new Uint8Array(65536),this.compatible_category_map=new Uint32Array(65536),this.invoke_definition_map=null}load(K,$,J){let q=new l;return q.character_category_map=K,q.compatible_category_map=$,q.invoke_definition_map=x.load(J),q}static parseCharCategory(K,$){let J=$[1],q=Number.parseInt($[2]),Q=Number.parseInt($[3]),X=Number.parseInt($[4]);if(!Number.isFinite(q)||q!==0&&q!==1)return console.log(`char.def parse error. INVOKE is 0 or 1 in:${q}`),null;if(!Number.isFinite(Q)||Q!==0&&Q!==1)return console.log(`char.def parse error. GROUP is 0 or 1 in:${Q}`),null;if(!Number.isFinite(X)||X<0)return console.log(`char.def parse error. LENGTH is 1 to n:${X}`),null;return new C(K,J,q===1,Q===1,X)}static parseCategoryMapping(K){let $=Number.parseInt(K[1]);if(!Number.isFinite($)||$<0||$>65535)console.log(`char.def parse error. CODE is invalid:${$}`);return{start:$,default:K[2],compatible:3<K.length?K.slice(3):[]}}static parseRangeCategoryMapping(K){let $=Number.parseInt(K[1]),J=Number.parseInt(K[2]);if(!Number.isFinite($)||$<0||$>65535)console.log(`char.def parse error. CODE is invalid:${$}`);if(!Number.isFinite(J)||J<0||J>65535)console.log(`char.def parse error. CODE is invalid:${J}`);return{start:$,end:J,default:K[3],compatible:4<K.length?K.slice(4):[]}}initCategoryMappings(K){if(!this.invoke_definition_map)throw new Error("CharacterDefinition.initCategoryMappings: invoke_definition_map is null");let $=0;if(K!=null){let Q=K.length;for(let X=0;X<Q;X++){let Z=K[X];for($=Z.start;$<=(Z.end||Z.start);$++){let H=this.invoke_definition_map.lookup(Z.default);if(H==null)throw new Error("CharacterDefinition.initCategoryMappings: invoke_definition_map.lookup() returns null");this.character_category_map[$]=H;for(let P=0;P<Z.compatible.length;P++){let W=this.compatible_category_map[$],Y=Z.compatible[P];if(Y==null)continue;let U=this.invoke_definition_map.lookup(Y);if(U==null)continue;let L=1<<U;W=W|L,this.compatible_category_map[$]=W}}}}let J=this.invoke_definition_map.lookup(b);if(J==null)return;let q=this.compatible_category_map.length;for($=0;$<q;$++)if(this.character_category_map[$]===0)this.character_category_map[$]=1<<J}lookupCompatibleCategory(K){let $=[];if(!this.invoke_definition_map)throw new Error("CharacterDefinition.lookupCompatibleCategory: invoke_definition_map is null");let J=K.charCodeAt(0),q=null;if(J<this.compatible_category_map.length)q=this.compatible_category_map[J];if(q==null||q===0)return $;for(let Q=0;Q<32;Q++)if(q<<31-Q>>>31===1){let X=this.invoke_definition_map.getCharacterClass(Q);if(X==null)continue;$.push(X)}return $}lookup(K){if(!this.invoke_definition_map)throw new Error("CharacterDefinition.lookup: invoke_definition_map is null");let $=null,J=K.charCodeAt(0);if(w.isSurrogatePair(K))$=this.invoke_definition_map.lookup(b);else if(J<this.character_category_map.length)$=this.character_category_map[J];if($==null)$=this.invoke_definition_map.lookup(b);return this.invoke_definition_map.getCharacterClass($)}}var I=l;class t extends z{#K=null;characterDefinition(K){return this.#K=K,this}lookup(K){if(this.#K==null)throw new Error("CharacterDefinition is not set");return this.#K.lookup(K)}lookupCompatibleCategory(K){if(this.#K==null)throw new Error("CharacterDefinition is not set");return this.#K.lookupCompatibleCategory(K)}loadUnknownDictionaries(K,$,J,q,Q,X){this.loadDictionary(K),this.loadPosVector($),this.loadTargetMap(J),this.#K=new I().load(q,Q,X)}}var m=t;class _{trie;token_info_dictionary;connection_costs;unknown_dictionary;constructor(K,$,J,q){this.trie=K??S.builder(0).build([{k:"",v:1}]),this.token_info_dictionary=$??new z,this.connection_costs=J??new D(0,0),this.unknown_dictionary=q??new m}loadTrie(K,$){return this.trie=S.load(K,$),this}loadTokenInfoDictionaries(K,$,J){return this.token_info_dictionary.loadDictionary(K),this.token_info_dictionary.loadPosVector($),this.token_info_dictionary.loadTargetMap(J),this}loadConnectionCosts(K){return this.connection_costs.loadConnectionCosts(K),this}loadUnknownDictionaries(K,$,J,q,Q,X){return this.unknown_dictionary.loadUnknownDictionaries(K,$,J,q,Q,X),this}}var h=_;var E8=/^(\w+)\s+(\d)\s+(\d)\s+(\d)/,I8=/^(0x[0-9A-F]{4})(?:\s+([^#\s]+))(?:\s+([^#\s]+))*/,z8=/^(0x[0-9A-F]{4})\.\.(0x[0-9A-F]{4})(?:\s+([^#\s]+))(?:\s+([^#\s]+))*/;class a{char_def;character_category_definition;category_mapping;constructor(){this.char_def=new I,this.char_def.invoke_definition_map=new x,this.character_category_definition=[],this.category_mapping=[]}putLine(K){let $=E8.exec(K);if($!=null){let Q=this.character_category_definition.length,X=I.parseCharCategory(Q,$);if(X==null)return;this.character_category_definition.push(X);return}let J=I8.exec(K);if(J!=null){let Q=I.parseCategoryMapping(J);this.category_mapping.push(Q)}let q=z8.exec(K);if(q!=null){let Q=I.parseRangeCategoryMapping(q);this.category_mapping.push(Q)}}build(){if(!this.char_def||!this.char_def.invoke_definition_map)throw new Error("No data to build.");return this.char_def.invoke_definition_map.init(this.character_category_definition),this.char_def.initCategoryMappings(this.category_mapping),this.char_def}}var n=a;class i{lines;connection_cost;constructor(){this.lines=0,this.connection_cost=null}putLine(K){if(this.lines===0||!this.connection_cost){let X=K.split(" "),Z=Number.parseInt(X[0]),H=Number.parseInt(X[1]);if(Z<0||H<0)throw"Parse error of matrix.def";return this.connection_cost=new D(Z,H),this.lines++,this}if(!this.connection_cost)throw"connection_cost is null";let $=K.split(" ");if($.length!==3)return this;let J=Number.parseInt($[0]),q=Number.parseInt($[1]),Q=Number.parseInt($[2]);if(J<0||q<0||!Number.isFinite(J)||!Number.isFinite(q)||this.connection_cost.forward_dimension<=J||this.connection_cost.backward_dimension<=q)throw"Parse error of matrix.def";return this.connection_cost.put(J,q,Q),this.lines++,this}build(){if(!this.connection_cost)throw"No data to build.";return this.connection_cost}}var r=i;class e{#K;#$;#q;#J;constructor(){this.#K=[],this.#$=[],this.#q=new r,this.#J=new n}addTokenInfoDictionary(K){let $=K.split(",");return this.#K.push($),this}putCostMatrixLine(K){return this.#q.putLine(K),this}putCharDefLine(K){return this.#J.putLine(K),this}putUnkDefLine(K){return this.#$.push(K.split(",")),this}build(){let K=this.buildTokenInfoDictionary();return new h(K.trie,K.token_info_dictionary,this.#q.build(),this.buildUnknownDictionary())}buildTokenInfoDictionary(){let K=new z,$=K.buildDictionary(this.#K),J=this.buildDoubleArray();for(let q in $){let Q=$[q],X=J.lookup(Q);K.addMapping(X,Number.parseInt(q))}return{trie:J,token_info_dictionary:K}}buildUnknownDictionary(){let K=new m,$=K.buildDictionary(this.#$),J=this.#J.build();if(!J||!J.invoke_definition_map)throw new Error("CharacterDefinition is not set");K.characterDefinition(J);for(let q in $){let Q=$[q],X=J.invoke_definition_map.lookup(Q);if(!X)throw new Error(`Class name not found: ${Q}`);K.addMapping(X,Number.parseInt(q))}return K}buildDoubleArray(){let K=0,$=this.#K.map((q)=>{return{k:q[0],v:K++}});return S.builder(1048576).build($)}}var K8=e;class $8{formatEntry(K,$,J,q){return{word_id:K,word_type:J,word_position:$,surface_form:q[0],pos:q[1],pos_detail_1:q[2],pos_detail_2:q[3],pos_detail_3:q[4],conjugated_type:q[5],conjugated_form:q[6],basic_form:q[7],reading:q[8],pronunciation:q[9]}}formatUnknownEntry(K,$,J,q,Q){return{word_id:K,word_type:J,word_position:$,surface_form:Q,pos:q[1],pos_detail_1:q[2],pos_detail_2:q[3],pos_detail_3:q[4],conjugated_type:q[5],conjugated_form:q[6],basic_form:q[7]}}}var q8=$8;class J8{name;cost;start_pos;length;left_id;right_id;prev;surface_form;shortest_cost;type;constructor(K,$,J,q,Q,X,Z,H){this.name=K,this.cost=$,this.start_pos=J,this.length=q,this.left_id=X,this.right_id=Z,this.prev=null,this.surface_form=H,this.shortest_cost=Q==="BOS"?0:Number.MAX_VALUE,this.type=Q}}var N=J8;class Q8{nodes_end_at;eos_pos;constructor(){this.nodes_end_at=[],this.nodes_end_at[0]=[new N(-1,0,0,0,"BOS",0,0,"")],this.eos_pos=1}append(K){let $=K.start_pos+K.length-1;if(this.eos_pos<$)this.eos_pos=$;let J=this.nodes_end_at[$]??[];J.push(K),this.nodes_end_at[$]=J}appendEos(){let K=this.nodes_end_at.length;this.eos_pos++,this.nodes_end_at[K]=[new N(-1,0,this.eos_pos,0,"EOS",0,0,"")]}}var X8=Q8;class Z8{#K;#$;#q;constructor(K){this.#K=K.trie,this.#$=K.token_info_dictionary,this.#q=K.unknown_dictionary}build(K){let $=new X8,J=new w(K),q=J.length;for(let Q=0;Q<q;Q++){let X=J.slice(Q),Z=this.#K.commonPrefixSearch(X),H=Z.length;for(let Y=0;Y<H;Y++){let U=Z[Y].v,L=Z[Y].k,T=this.#$.target_map.get(U);if(!T)throw new Error("TokenInfo dictionary is broken");for(let M of T){let E=this.#$.dictionary.getShort(M),V=this.#$.dictionary.getShort(M+2),B=this.#$.dictionary.getShort(M+4);$.append(new N(M,B,Q+1,L.length,"KNOWN",E,V,L))}}let P=X.charAt(0),W=this.#q.lookup(P);if(!Z?.length||W.is_always_invoke){let Y=P,U=X.length;if(W.is_grouping&&U>1){let E=W.class_name;for(let V=1;V<U;V++){let B=X.charAt(V);if(this.#q.lookup(B).class_name!==E)break;Y+=B}}let L=this.#q.target_map.get(W.class_id);if(!L)throw new Error("Unknown dictionary is broken");let T=L.length,M=this.#q.dictionary;for(let E=0;E<T;E++){let V=L[E];$.append(new N(V,M.getShort(V+4),Q+1,Y.length,"UNKNOWN",M.getShort(V),M.getShort(V+2),Y))}}}return $.appendEos(),$}}var H8=Z8;class P8{#K;constructor(K){this.#K=K}search(K){let $=K;return $=this.#$($),this.#q($)}#$(K){let $=1;for($=1;$<=K.eos_pos;$++){let J=K.nodes_end_at[$];if(J==null)continue;for(let q of J){let Q=Number.MAX_VALUE,X=null,Z=q.start_pos-1;if(!(Z in K.nodes_end_at))continue;let H=K.nodes_end_at[Z];for(let P of H){let W;if(q.left_id==null||P.right_id==null)console.log("Left or right is null"),W=0;else W=this.#K.get(P.right_id,q.left_id);let Y=P.shortest_cost+W+q.cost;if(Y<Q)X=P,Q=Y}q.prev=X,q.shortest_cost=Q}}return K}#q(K){let $=[],q=K.nodes_end_at[K.nodes_end_at.length-1][0].prev;if(q==null)return[];while(q.type!=="BOS"){if($.push(q),q.prev==null)return[];q=q.prev}return $.reverse()}}var W8=P8;class u{#K;#$;#q;#J;#Q;constructor(K){this.#K=K.token_info_dictionary,this.#$=K.unknown_dictionary,this.#q=new H8(K),this.#J=new W8(K.connection_costs),this.#Q=new q8}static splitByPunctuation(K){let $=K.matchAll(/\u3001|\u3002/g),J=[],q=0;for(let Q of $){let X=Q.index;J.push(K.slice(q,X+1)),q=X+1}if(q<K.length)J.push(K.slice(q));return J}tokenize(K){let $=u.splitByPunctuation(K),J=[];for(let q of $)this.#X(q,J);return J}#X(K,$=[]){let J=this.#q.build(K),q=this.#J.search(J),Q=$.length>0?$[$.length-1].word_position:0;for(let X of q)$.push(this.#Z(X,Q));return $}#Z(K,$){let J=K.type==="KNOWN"?this.#K.getFeatures(K.name):this.#$.getFeatures(K.name),q=J?J.split(","):[];if(K.type==="UNKNOWN")return this.#Q.formatUnknownEntry(K.name,$+K.start_pos,K.type,q,K.surface_form);return this.#Q.formatEntry(K.name,$+K.start_pos,K.type,q)}}var Y8=u;import{existsSync as N8,readFileSync as R8}from"fs";import S8 from"path";import A8 from"zlib";class U8{#K;constructor(K="dict/"){this.#K=K}#$=(K)=>new Promise(($,J)=>{if(!N8(K))return J(new Error(`${K} does not exist`));let q=R8(K);A8.gunzip(new Uint8Array(q),(Q,X)=>{if(Q)return J(Q);let Z=new Uint8Array(X);$(Z.buffer)})});load=()=>new Promise((K,$)=>{let J=new h;Promise.all(["base.dat.gz","check.dat.gz","tid.dat.gz","tid_pos.dat.gz","tid_map.dat.gz","cc.dat.gz","unk.dat.gz","unk_pos.dat.gz","unk_map.dat.gz","unk_char.dat.gz","unk_compat.dat.gz","unk_invoke.dat.gz"].map((q)=>this.#$(S8.join(this.#K,q)))).then((q)=>{J.loadTrie(new Int32Array(q[0]),new Int32Array(q[1])),J.loadTokenInfoDictionaries(new Uint8Array(q[2]),new Uint8Array(q[3]),new Uint8Array(q[4])),J.loadConnectionCosts(new Int16Array(q[5])),J.loadUnknownDictionaries(new Uint8Array(q[6]),new Uint8Array(q[7]),new Uint8Array(q[8]),new Uint8Array(q[9]),new Uint32Array(q[10]),new Uint8Array(q[11])),K(J)}).catch((q)=>{$(q)})})}var G8=U8;class L8{#K;constructor(K={}){this.#K=new G8(K.dicPath)}async build(){let K=await this.#K.load();return new Y8(K)}}var V8=L8;var wK={builder:(K={})=>{return new V8(K)},dictionaryBuilder:()=>{return new K8}};export{wK as default,V8 as TokenizerBuilder,K8 as DictionaryBuilder};

//# debugId=87C2518EF0B93FCD64756E2164756E21
//# sourceMappingURL=index.min.js.map
